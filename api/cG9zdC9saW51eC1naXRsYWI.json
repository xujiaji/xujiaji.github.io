{"title":"安装Gitlab小记","date":"2019-09-24T12:49:42.000Z","thumbnail":"https://xujiaji.oss-cn-beijing.aliyuncs.com/blog/gitlab/gitlab-logo-gray-rgb.jpg","link":"post/linux-gitlab","comments":true,"tags":["CentOS","Git","Linux"],"updated":"2019-09-24T16:44:06.107Z","content":"<h1 id=\"安装Gitlab小记\">安装Gitlab小记<a href=\"post/linux-gitlab#安装Gitlab小记\"></a></h1><blockquote>\n<p>环境：CentOS7.6、外部Nginx</p>\n</blockquote>\n<h2 id=\"做了些什么？\">做了些什么？<a href=\"post/linux-gitlab#做了些什么？\"></a></h2><ol>\n<li>安装gitlab</li>\n<li>配置发送邮箱（用来验证账号修改密码）</li>\n<li>外置nginx配置（https）</li>\n<li>汉化</li>\n<li>CI Pipelines安装</li>\n</ol>\n<h2 id=\"安装Gitlab\">安装Gitlab<a href=\"post/linux-gitlab#安装Gitlab\"></a></h2><p>安装配合依赖（其实这里都是官网的安装说文档，我就直接搬运过来了）</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum install -y curl policycoreutils-python openssh-server</span><br><span class=\"line\">sudo systemctl enable sshd</span><br><span class=\"line\">sudo systemctl start sshd</span><br><span class=\"line\"></span><br><span class=\"line\">sudo firewall-cmd --permanent --add-service=http</span><br><span class=\"line\">sudo firewall-cmd --permanent --add-service=https</span><br><span class=\"line\">sudo systemctl reload firewalld</span><br></pre></td></tr></table></div></figure>\n<p>添加Gitlab仓库</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | sudo bash</span><br></pre></td></tr></table></div></figure>\n<p>安装Gitlab，这里的<code>EXTERNAL_URL</code>换成自己的域名</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo EXTERNAL_URL=\"https://gitlab.example.com\" yum install -y gitlab-ee</span><br></pre></td></tr></table></div></figure>\n<h2 id=\"配置邮箱（不配置可以跳过这个步骤）\">配置邮箱（不配置可以跳过这个步骤）<a href=\"post/linux-gitlab#配置邮箱（不配置可以跳过这个步骤）\"></a></h2><p>打开配置文件，添加邮箱配置。</p>\n<p>这里以qq邮箱来举栗子（因为我配置的qq邮箱😆），其他都差不多类似。</p>\n<p>注意需要在邮箱设置中开启smtp服务</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/gitlab/gitlab.rb</span><br></pre></td></tr></table></div></figure>\n<blockquote>\n<p>直接在文件中添加下方配置</p>\n</blockquote>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab_rails['smtp_enable'] = true</span><br><span class=\"line\">gitlab_rails['smtp_address'] = \"smtp.qq.com\"</span><br><span class=\"line\">gitlab_rails['smtp_port'] = 465</span><br><span class=\"line\">gitlab_rails['smtp_user_name'] = \"邮箱名@qq.com\"</span><br><span class=\"line\">gitlab_rails['smtp_password'] = \"dtjhinszpsasdhi\"</span><br><span class=\"line\">gitlab_rails['smtp_domain'] = \"smtp.qq.com\"</span><br><span class=\"line\">gitlab_rails['smtp_authentication'] = \"login\"</span><br><span class=\"line\">gitlab_rails['smtp_enable_starttls_auto'] = true</span><br><span class=\"line\">gitlab_rails['smtp_tls'] = true</span><br></pre></td></tr></table></div></figure>\n<div class=\"article-bounded\"><div class=\"article-table\"><table>\n<thead>\n<tr>\n<th>字段</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>smtp_enable</code></td>\n<td>启用smtp</td>\n</tr>\n<tr>\n<td><code>smtp_address</code></td>\n<td>smtp.qq.com是qq的smtp服务器，根据自己的情况更换</td>\n</tr>\n<tr>\n<td><code>smtp_user_name</code></td>\n<td>是你要用来让gitlab发送的邮箱</td>\n</tr>\n<tr>\n<td><code>smtp_password</code></td>\n<td>是邮箱的登录密码（QQ的是在设置中生成的第三方登录密码）</td>\n</tr>\n<tr>\n<td><code>smtp_tls</code></td>\n<td>开启tls加密</td>\n</tr>\n</tbody>\n</table></div></div>\n<p>配置邮箱来源，与展示的名称</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab_rails['gitlab_email_enabled'] = true</span><br><span class=\"line\">gitlab_rails['gitlab_email_from'] = '邮箱名@qq.com'</span><br><span class=\"line\">gitlab_rails['gitlab_email_display_name'] = '发送邮件的默认标题'</span><br></pre></td></tr></table></div></figure>\n<h2 id=\"外置nginx配置\">外置nginx配置<a href=\"post/linux-gitlab#外置nginx配置\"></a></h2><h3 id=\"关闭Gilab内部nginx和一些其他配置\">关闭Gilab内部nginx和一些其他配置<a href=\"post/linux-gitlab#关闭Gilab内部nginx和一些其他配置\"></a></h3><p>打开配置文件</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/gitlab/gitlab.rb</span><br></pre></td></tr></table></div></figure>\n<p>添加如下配置</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">external_url 'https://git.longpuji.com'</span><br><span class=\"line\"></span><br><span class=\"line\">gitlab_workhorse['enable'] = true</span><br><span class=\"line\">gitlab_workhorse['listen_network'] = \"tcp\"</span><br><span class=\"line\">gitlab_workhorse['listen_addr'] = \"127.0.0.1:8181\"</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> This example renews every 7th day at 12:30</span></span><br><span class=\"line\">letsencrypt['auto_renew_hour'] = \"12\"</span><br><span class=\"line\">letsencrypt['auto_renew_minute'] = \"30\"</span><br><span class=\"line\">letsencrypt['auto_renew_day_of_month'] = \"*/7\"</span><br><span class=\"line\"></span><br><span class=\"line\">nginx['enable'] = false</span><br></pre></td></tr></table></div></figure>\n<div class=\"article-bounded\"><div class=\"article-table\"><table>\n<thead>\n<tr>\n<th>字段</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>external_url</code></td>\n<td>外部的url使用的url，如果不配置会导致有些链接不正常</td>\n</tr>\n<tr>\n<td><code>gitlab_workhorse[&#39;enable&#39;]</code></td>\n<td>开启gitlab工作空间配置</td>\n</tr>\n<tr>\n<td><code>gitlab_workhorse[&#39;listen_network&#39;]</code></td>\n<td>tcp网络协议</td>\n</tr>\n<tr>\n<td><code>gitlab_workhorse[&#39;listen_addr&#39;]</code></td>\n<td><code>127.0.0.1:8181</code>（一会儿nginx反向代理的时候就用这个端口号）</td>\n</tr>\n<tr>\n<td><code>nginx[&#39;enable&#39;]</code></td>\n<td>关闭Gitlab内部nginx</td>\n</tr>\n</tbody>\n</table></div></div>\n<h3 id=\"为外部nginx反向代理配置\">为外部nginx反向代理配置<a href=\"post/linux-gitlab#为外部nginx反向代理配置\"></a></h3><p>配置如下</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    expires 12h;</span><br><span class=\"line\">    if ($request_uri ~* \"(php|jsp|cgi|asp|aspx)\")</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">         expires 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    # 这个就是上面设置的gitlab_workhorse['listen_addr']</span><br><span class=\"line\">    proxy_pass http://127.0.0.1:8181;</span><br><span class=\"line\">    proxy_set_header Host $host;</span><br><span class=\"line\">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">    proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class=\"line\">    # 注意如果是域名配置了ssl，那么则必须加上这个配置，不然gitlab会在重置密码的时候报错422</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Proto https;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Ssl on;</span><br><span class=\"line\"></span><br><span class=\"line\">    proxy_read_timeout                  900;</span><br><span class=\"line\">    proxy_cache off;</span><br><span class=\"line\">    proxy_buffering off;</span><br><span class=\"line\">    proxy_request_buffering off;</span><br><span class=\"line\">    proxy_http_version 1.1;</span><br><span class=\"line\"></span><br><span class=\"line\">    add_header X-Cache $upstream_cache_status;</span><br><span class=\"line\">    add_header Cache-Control no-cache;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<h2 id=\"启动\">启动<a href=\"post/linux-gitlab#启动\"></a></h2><blockquote>\n<p>上面的那些基本上Gitlab就已经配置好啦，现在需要对Gitlab重新加载配置和重启</p>\n</blockquote>\n<p>重载配置</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab-ctl reconfigure</span><br></pre></td></tr></table></div></figure>\n<p>重启服务</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab-ctl start</span><br></pre></td></tr></table></div></figure>\n<p>到这里可以打开域名链接去看看，没有啥问题就可以正常使用，第一次进入的时候需要设置初始密码。<br>初始的账号是<code>root</code><br>去登陆试试吧</p>\n<h2 id=\"汉化\">汉化<a href=\"post/linux-gitlab#汉化\"></a></h2><p>查看当前版本</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /opt/gitlab/embedded/service/gitlab-rails/VERSION</span><br></pre></td></tr></table></div></figure>\n<p>输出</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">12.3.0-ee</span><br></pre></td></tr></table></div></figure>\n<blockquote>\n<p>由于汉化现在还没有支持到这么高的版本，于是这里以v12.2.4的版本汉化的。（大部分都没有被汉化😅，之后如果该仓库更新的对应版本可以再次尝试）</p>\n</blockquote>\n<p>clone汉化项目</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https://gitlab.com/xhang/gitlab.git</span><br></pre></td></tr></table></div></figure>\n<p>进入仓库</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd gitlab</span><br></pre></td></tr></table></div></figure>\n<p>备份<code>gitlab-rails</code>到当前目录（如果之后出现问题，方便恢复）</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp -rf /opt/gitlab/embedded/service/gitlab-rails/ .</span><br></pre></td></tr></table></div></figure>\n<p>生成12.2.4版本的汉化补丁</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git diff v12.2.4 v12.2.4-zh &gt; ./12.2.4-zh.diff</span><br></pre></td></tr></table></div></figure>\n<p>关闭gitlab服务</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab-ctl stop</span><br></pre></td></tr></table></div></figure>\n<p>打汉化补丁</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">patch -d /opt/gitlab/embedded/service/gitlab-rails/ -p1 &lt; ./12.2.4-zh.diff</span><br></pre></td></tr></table></div></figure>\n<blockquote>\n<p>这里有些汉化文件没有对应到的文件，直接回车，yes跳过就可以了</p>\n</blockquote>\n<p>启动服务</p>\n<figure class=\"highlight shell\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab-ctl start</span><br></pre></td></tr></table></div></figure>\n<h2 id=\"CI-Pipelines安装\">CI Pipelines安装<a href=\"post/linux-gitlab#CI-Pipelines安装\"></a></h2><p>这篇文件不错，我就不啰嗦了哈哈</p>\n<p><a href=\"https://scarletsky.github.io/2016/07/29/use-gitlab-ci-for-continuous-integration/\" target=\"_blank\" rel=\"noopener\">https://scarletsky.github.io/2016/07/29/use-gitlab-ci-for-continuous-integration/</a></p>\n<h2 id=\"命令文件整理\">命令文件整理<a href=\"post/linux-gitlab#命令文件整理\"></a></h2><blockquote>\n<p>命令整理</p>\n</blockquote>\n<div class=\"article-bounded\"><div class=\"article-table\"><table>\n<thead>\n<tr>\n<th>命令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>gitlab-ctl reconfigure</code></td>\n<td>重载gitlab配置</td>\n</tr>\n<tr>\n<td><code>gitlab-ctl restart</code></td>\n<td>重启gitlab</td>\n</tr>\n<tr>\n<td><code>gitlab-ctl stop</code></td>\n<td>停止gitlab服务</td>\n</tr>\n<tr>\n<td><code>gitlab-ctl start</code></td>\n<td>启动gitlab服务</td>\n</tr>\n</tbody>\n</table></div></div>\n<blockquote>\n<p>文件说明</p>\n</blockquote>\n<div class=\"article-bounded\"><div class=\"article-table\"><table>\n<thead>\n<tr>\n<th>文件</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>/etc/gitlab/gitlab.rb</code></td>\n<td>gitlab配置文件</td>\n</tr>\n<tr>\n<td><code>/var/log/gitlab/gitlab-rails/production.log</code></td>\n<td>gitlab-rails日志文件</td>\n</tr>\n</tbody>\n</table></div></div>\n","next":{"title":"OpenGL Android课程七：介绍Vertex Buffer Objects（顶点缓冲区对象，简称：VBO）","link":"post/Learn-OpenGL-Lesson-Seven"},"plink":"https://blog.xujiaji.com/post/linux-gitlab/","toc":[{"title":"安装Gitlab小记","id":"安装Gitlab小记","index":"1","children":[{"title":"做了些什么？","id":"做了些什么？","index":"1.1"},{"title":"安装Gitlab","id":"安装Gitlab","index":"1.2"},{"title":"配置邮箱（不配置可以跳过这个步骤）","id":"配置邮箱（不配置可以跳过这个步骤）","index":"1.3"},{"title":"外置nginx配置","id":"外置nginx配置","index":"1.4","children":[{"title":"关闭Gilab内部nginx和一些其他配置","id":"关闭Gilab内部nginx和一些其他配置","index":"1.4.1"},{"title":"为外部nginx反向代理配置","id":"为外部nginx反向代理配置","index":"1.4.2"}]},{"title":"启动","id":"启动","index":"1.5"},{"title":"汉化","id":"汉化","index":"1.6"},{"title":"CI Pipelines安装","id":"CI-Pipelines安装","index":"1.7"},{"title":"命令文件整理","id":"命令文件整理","index":"1.8"}]}],"reward":true,"copyright":{"author":"XuJiaji","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow noopener\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)","link":"<a href=\"https://blog.xujiaji.com/post/linux-gitlab/\" title=\"安装Gitlab小记\">https://blog.xujiaji.com/post/linux-gitlab/</a>"}}